@page "/texture-inspector"
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<h3>EXRテクスチャ インスペクター</h3>
<p>キャンバスをクリックして、その地点のピクセル値（RGBA）を取得します。</p>

<div class="row">
    <div class="col-md-8">
        <canvas id="texture-canvas" style="width: 100%; border: 1px solid #ccc;"></canvas>
    </div>
    <div class="col-md-4">
        <h5>ピクセル情報</h5>
        <p>
            座標: (@_pixelX, @_pixelY)
        </p>
        <p>
            <strong>R:</strong> @_pixelValueR<br />
            <strong>G:</strong> @_pixelValueG<br />
            <strong>B:</strong> @_pixelValueB<br />
            <strong>A:</strong> @_pixelValueA
        </p>
        <p>
            <small>※テクスチャのサイズはコンソールに出力されます。</small>
        </p>
    </div>
</div>

@code {
    private int _pixelX;
    private int _pixelY;
    private float _pixelValueR;
    private float _pixelValueG;
    private float _pixelValueB;
    private float _pixelValueA;

    private IJSObjectReference? _module;
    private DotNetObjectReference<TextureInspector>? _dotNetHelper;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetHelper = DotNetObjectReference.Create(this);
            _module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/texture-inspector.js");
            await _module.InvokeVoidAsync("initTextureInspector", "texture-canvas", "textures/Cube_pos.exr", _dotNetHelper);
        }
    }

    [JSInvokable]
    public void SetPixelValue(int x, int y, float r, float g, float b, float a)
    {
        _pixelX = x;
        _pixelY = y;
        _pixelValueR = r;
        _pixelValueG = g;
        _pixelValueB = b;
        _pixelValueA = a;
        StateHasChanged();
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
        }
        _dotNetHelper?.Dispose();
    }
}
